# Run your Docker containers for free in the cloud and for unlimited time

Having a place other than your own machine to run docker containers can be handy.
It helps you to speed up the development of your personal projects or relieve the
heavy lifting from your machine.  
Recently I was introduced Oracle cloud, and its free tier for an unlimited time.

## Check the supported always free services:

- 2 AMD based Compute VMs with 1/8 OCPU\*\* and 1 GB memory each
- 4 Arm-based Ampere A1 cores and 24 GB of memory usable as one VM or up to 4 VMs
- 2 Block Volumes Storage, 200 GB total
- 10 GB Object Storage - Standard
- 10 GB Object Storage - Infrequent Access
- 10 GB Archive Storage
- Resource Manager: managed Terraform
- 5 OCI Bastions

As you can see they are very generous with their free tier, and we can do a lot
with this.

## Create your remote Docker service

1. Create an Oracle Cloud Infrastructure account (just follow [this link](https://signup.cloud.oracle.com/)).
2. [Install terraform](https://learn.hashicorp.com/tutorials/terraform/install-cli?in=terraform/oci-get-started).
3. [Install OCI CLI](https://docs.oracle.com/en-us/iaas/Content/API/SDKDocs/cliinstall.htm).
4. [Configure OCI credentials](https://learn.hashicorp.com/tutorials/terraform/oci-build?in=terraform/oci-get-started).

As you can suspect by now, we are going to use terraform to provision our Docker service. Basically terraform will create one VM instance as big as the free tear allow us, and let it ready so we can ssh into the machine and with docker ready to start our containers.

5. Checkout this project with the terraform configuration
6. Run `terraform init` and `terraform apply`

If you get an error like this:

```
timeout -- last error: dial tcp IP_ADDRESS:22: connect: connection refused
```

try to add the id_rsa generated by terraform to your ssh-agent ( `ssh-add id_rsa` ) and run terraform apply one more time.

If you were able to reach this point, you now have a VM running that you can run whatever you want (check Oracle's terms and conditions for this service). At the end of the process terraform is configured to show the public IP of newly created instance.
What I like to do is to add this to /etc/hosts so I don't need to call it by the IP address.  
Connect to the remote server using ssh and run docker ps to check if docker is running as expected.

## Deploying your container

OK, now you want to start running containers there from your local machine, but you also run some containers locally for whatever reason.
So we need to do it in a way that is easy to switch between the two contexts.
Docker has a tool for that embedded on its client, to check the contexts that you have available run:

```
docker context ls 
```

Let's create a context for our remote docker service:

```
docker context create remote --docker "host=ssh://docker@IP_PROVIDED_BY_TERRAFORM
```

Now if you list your contexts again you should see your newly created context. The next step is to switch between contexts:

```
docker context use remote
```

Now you can run any command that you would normally do locally. To check if it is working try to deploy a nginx container.

```
docker run -d -p 8080:80 nginx 
```

After this you should be able to open on your browser: http://IP_PROVIDED_BY_TERRAFORM:8080 and you should see the default index.html from docker.

## Possible errors and how to address them

### Authentication problem

If you configured OCI authentication using a session token
(with `oci session authenticate`), please note that this token
is valid 1 hour by default. If you authenticate, then wait more
than 1 hour, then try to `terraform apply`, you will get
authentication errors.

#### Symptom

The following message:

```
 Error: 401-NotAuthenticated
│ Service: Identity Compartment
│ Error Message: The required information to complete authentication was not provided or was incorrect.
│ OPC request ID: [...]
│ Suggestion: Please retry or contact support for help with service: Identity Compartment
```

#### Solution

Authenticate or re-authenticate, for instance with
`oci session authenticate`.

If prompted for the profile name, make sure to enter `DEFAULT`
so that Terraform automatically uses the session token.

If you previously used `oci session authenticate`, you
should be able to refresh the session with
`oci session refresh --profile DEFAULT`.

### Capacity issue

#### Symptom

If you get a message like the following one:

```
Error: 500-InternalError
│ ...
│ Service: Core Instance
│ Error Message: Out of host capacity.
```

It means that there isn't enough servers available at the moment
on OCI to create the cluster.

#### Solution

One solution is to switch to a different _availability domain_.
This can be done by changing the `availability_domain` input variable. (Thanks @uknbr for the contribution!)

Note 1: some regions have only one availability domain. In that
case you cannot change the availability domain.

Note 2: OCI accounts (especially free accounts) are tied to a
single region, so if you get that problem and cannot change the
availability domain, you can [create another account][createaccount].

### Using the wrong region

#### Symptom

When doing `terraform apply`, you get this message:

```
oci_identity_compartment._: Creating...
╷
│ Error: 404-NotAuthorizedOrNotFound
│ Service: Identity Compartment
│ Error Message: Authorization failed or requested resource not found
│ OPC request ID: [...]
│ Suggestion: Either the resource has been deleted or service Identity Compartment need policy to access this resource. Policy reference: https://docs.oracle.com/en-us/iaas/Content/Identity/Reference/policyreference.htm
│
│
│   with oci_identity_compartment._,
│   on main.tf line 1, in resource "oci_identity_compartment" "_":
│    1: resource "oci_identity_compartment" "_" {
│
╵
```

#### Solution

Edit `~/.oci/config` and change the `region=` line to put the correct region.

To know what's the correct region, you can try to log in to
https://cloud.oracle.com/ with your account; after logging in,
you should be redirected to an URL that looks like
https://cloud.oracle.com/?region=us-ashburn-1 and in that
example the region is `us-ashburn-1`.

### Troubleshooting cluster creation

After the VMs are created, you can log into the VMs with the
`ubuntu` user and the SSH key contained in the `id_rsa` file
that was created by Terraform.

Then you can check the cloud init output file, e.g. like this:

```
tail -n 100 -f /var/log/cloud-init-output.log
```
